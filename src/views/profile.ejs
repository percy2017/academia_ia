<%- contentFor('title') %>
Mi Cuenta - Academia AI
<%- contentFor('body') %>

<div class="container-fluid mt-4 profile-page">
    <div class="row">
        <div class="col-12">
            <h1 class="h2 mb-4">Mi Cuenta</h1>
        </div>
    </div>

    <% if (messages && messages.success_msg && messages.success_msg.length > 0) { %>
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            <%= messages.success_msg %>
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    <% } %>
    <% if (messages && messages.error_msg && messages.error_msg.length > 0) { %>
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            <%= messages.error_msg %>
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    <% } %>

    <% if (user) { %>
        <!-- Sección de Detalles de la Cuenta -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">Detalles de la Cuenta</h5>
            </div>
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col-md-3 text-center mb-3 mb-md-0">
                        <% if (user.avatarUrl) { %>
                            <img src="<%= user.avatarUrl %>" alt="Avatar de <%= user.name %>" class="img-fluid rounded-circle" style="width: 120px; height: 120px; object-fit: cover;">
                        <% } else { %>
                            <svg xmlns="http://www.w3.org/2000/svg" width="120" height="120" fill="currentColor" class="bi bi-person-circle text-secondary" viewBox="0 0 16 16">
                                <path d="M11 6a3 3 0 1 1-6 0 3 3 0 0 1 6 0z"/>
                                <path fill-rule="evenodd" d="M0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8zm8-7a7 7 0 0 0-5.468 11.37C3.242 11.226 4.805 10 8 10s4.757 1.225 5.468 2.37A7 7 0 0 0 8 1z"/>
                            </svg>
                        <% } %>
                    </div>
                    <div class="col-md-9">
                        <p><strong>Nombre:</strong> <%= user.name || 'No especificado' %></p>
                        <p><strong>Correo Electrónico:</strong> <%= user.email %></p>
                        <p><strong>Teléfono:</strong> <%= user.phone || 'No especificado' %></p>
                        <p><strong>Rol:</strong> <span class="text-capitalize"><%= user.role.toLowerCase() %></span></p>
                        <p><strong>Miembro desde:</strong> <%= new Date(user.createdAt).toLocaleDateString('es-ES', { year: 'numeric', month: 'long', day: 'numeric' }) %></p>
                        <a href="/profile/edit" class="btn btn-outline-primary mt-2">
                            <i class="bi bi-pencil-square me-1"></i>Editar Detalles
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sección de Mis Cursos -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Mis Cursos Inscritos</h5>
            </div>
            <div class="card-body">
                <% if (enrolledCourses && enrolledCourses.length > 0) { %>
                    <div class="table-responsive">
                        <table class="table table-hover" id="myCoursesTable">
                            <thead>
                                <tr>
                                    <th style="width: 10%;">Imagen</th>
                                    <th>Título del Curso</th>
                                    <th>Descripción</th>
                                    <th style="width: 15%;">Acción</th>
                                </tr>
                            </thead>
                            <tbody>
                                <% enrolledCourses.forEach(course => { %>
                                    <tr>
                                        <td>
                                            <% if (course.imageUrl) { %>
                                                <img src="<%= course.imageUrl %>" alt="<%= course.title %>" class="img-fluid" style="max-height: 50px; object-fit: cover; border-radius: .25rem;">
                                            <% } else { %>
                                                <div style="width: 100%; height: 50px; background-color: #e9ecef; display: flex; align-items: center; justify-content: center; border-radius: .25rem;">
                                                    <small class="text-muted">Sin img</small>
                                                </div>
                                            <% } %>
                                        </td>
                                        <td><%= course.title %></td>
                                        <td><%= course.description ? course.description.substring(0, 100) + (course.description.length > 100 ? '...' : '') : 'N/A' %></td>
                                        <td>
                                            <a href="/courses/<%= course.id %>" class="btn btn-sm btn-primary">
                                                <i class="bi bi-eye-fill me-1"></i>Ir al Curso
                                            </a>
                                        </td>
                                    </tr>
                                <% }); %>
                            </tbody>
                        </table>
                    </div>
                <% } else { %>
                    <div class="alert alert-info mb-0" role="alert">
                        Aún no te has inscrito en ningún curso. ¡<a href="/" class="alert-link">Explora nuestro catálogo de cursos</a> y comienza a aprender!
                    </div>
                <% } %>
            </div>
        </div>
    <% } else { %>
        <div class="alert alert-danger" role="alert">
            No se pudo cargar la información del perfil. Por favor, <a href="/auth/login" class="alert-link">intenta iniciar sesión</a> nuevamente.
        </div>
    <% } %>
</div>

<%- contentFor('scripts') %>
<script>
    $(document).ready(function() {
        if ($('#myCoursesTable').length && $.fn.DataTable) { // Verificar que la tabla y DataTables existan
            try {
                $('#myCoursesTable').DataTable({
                    "language": {
                        "url": "//cdn.datatables.net/plug-ins/1.13.6/i18n/es-ES.json"
                    },
                    "order": [], 
                    "pageLength": 5,
                    "lengthMenu": [ [5, 10, 25, -1], [5, 10, 25, "Todos"] ],
                    "autoWidth": false, // Puede ayudar con el layout
                    "responsive": true // Para mejor adaptación en móviles
                });
                console.log("DataTables para 'Mis Cursos' inicializado.");
            } catch (e) {
                console.error("Error inicializando DataTables para 'Mis Cursos':", e);
            }
        } else {
            if (!$('#myCoursesTable').length) console.log("Tabla #myCoursesTable no encontrada.");
            if (!$.fn.DataTable) console.log("DataTables plugin no está cargado en jQuery.");
        }
    });
</script>
